const express = require("express");
const sqlite3 = require("sqlite3").verbose();
const bodyParser = require("body-parser");
const app = express();

app.use(bodyParser.json());
app.use(express.static("public"));

const db = new sqlite3.Database("db.sqlite");

const QUOTA = 10;
const MONTHS = [
  "gennaio","febbraio","marzo","aprile","maggio","giugno",
  "luglio","agosto","settembre","ottobre","novembre","dicembre"
];

let GROUP = [
  "Nuhi","Abdullah","Alajdin","Beratconst express = require("express");
const sqlite3 = require("sqlite3").verbose();
const bodyParser = require("body-parser");
const app = express();

app.use(bodyParser.json());
app.use(express.static("public"));

const db = new sqlite3.Database("db.sqlite");

const QUOTA = 10;
const MONTHS = [
  "gennaio","febbraio","marzo","aprile","maggio","giugno",
  "luglio","agosto","settembre","ottobre","novembre","dicembre"
];

let GROUP = [
  "Nuhi","Abdullah","Alajdin","Berat","Besnik","Albit",
  "Erhan","Gajur","Kemo","Mazem","Samir","Sinan","Zumer"
];

const ISLAMIC_QUOTES = [
  {arab:"Ø§Ù„ØµØ¨Ø± Ù…ÙØªØ§Ø­ Ø§Ù„ÙØ±Ø¬", it:"La pazienza Ã¨ la chiave della felicitÃ "},
  {arab:"Ø¥Ù† Ø§Ù„Ù„Ù‡ Ù…Ø¹ Ø§Ù„ØµØ§Ø¨Ø±ÙŠÙ†", it:"Dio Ã¨ con chi persevera"},
  {arab:"Ø§ÙØ¹Ù„ Ø§Ù„Ø®ÙŠØ± ØªØ±Ù‰ Ø§Ù„Ø®ÙŠØ±", it:"Fai del bene e vedrai il bene"},
  {arab:"Ù…Ù† Ø±Ø­ÙÙ… Ø±ÙØ²ÙÙ‚ Ø±Ø­Ù…Ø©", it:"Chi Ã¨ misericordioso sarÃ  ricompensato"},
  {arab:"Ø§Ù„Ø¥ÙŠÙ…Ø§Ù† ÙŠØ­Ø±Ùƒ Ø§Ù„Ø¬Ø¨Ø§Ù„", it:"La fede muove le montagne"}
];

// crea tabelle
db.serialize(()=>{
  db.run(`CREATE TABLE IF NOT EXISTS users(
    name TEXT PRIMARY KEY,
    role TEXT
  )`);

  db.run(`CREATE TABLE IF NOT EXISTS payments(
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user TEXT,
    month TEXT,
    amount INTEGER,
    type TEXT
  )`);

  db.run(`CREATE TABLE IF NOT EXISTS totals(
    id INTEGER PRIMARY KEY,
    totalQuota INTEGER,
    totalExtra INTEGER
  )`);

  // Inserisce utenti fissi
  GROUP.forEach(n=>{
    db.run(
      "INSERT OR IGNORE INTO users(name,role) VALUES(?,?)",
      [n, n==="Nuhi"?"admin":"user"]
    );
  });

  // Inizializza totals
  db.run("INSERT OR IGNORE INTO totals(id,totalQuota,totalExtra) VALUES(1,0,0)");
});

// LOGIN
app.post("/login",(req,res)=>{
  const name = req.body.name;
  if(!GROUP.includes(name)) return res.status(403).json({error:"NON AUTORIZZATO"});
  db.get("SELECT * FROM users WHERE name=?",[name],(e,u)=>res.json(u));
});

// ADMIN: aggiungi pagamento (quota o extra)
app.post("/admin/pay",(req,res)=>{
  const {admin,user,month,amount,type} = req.body;
  if(admin!=="Nuhi") return res.status(403).json({error:"solo admin"});
  if(!GROUP.includes(user)) return res.status(400).json({error:"utente non valido"});
  if(type==="quota" && !MONTHS.includes(month)) return res.status(400).json({error:"mese non valido"});

  if(type==="quota"){
    db.get("SELECT * FROM payments WHERE user=? AND month=? AND type='quota'", [user, month], (e,row)=>{
      if(row) return res.status(400).json({error:"Mese giÃ  pagato"});
      db.run("INSERT INTO payments(user,month,amount,type) VALUES(?,?,?,?)",[user,month,amount,"quota"],()=>{
        db.get("SELECT * FROM totals WHERE id=1",(e,t)=>{
          let newQuota = t.totalQuota + amount;
          db.run("UPDATE totals SET totalQuota=? WHERE id=1",[newQuota],()=>res.json({ok:true}));
        });
      });
    });
  } else if(type==="extra"){
    db.run("INSERT INTO payments(user,month,amount,type) VALUES(?,?,?,?)",[user,"extra",amount,"extra"],()=>{
      db.get("SELECT * FROM totals WHERE id=1",(e,t)=>{
        let newExtra = t.totalExtra + amount;
        db.run("UPDATE totals SET totalExtra=? WHERE id=1",[newExtra],()=>res.json({ok:true}));
      });
    });
  } else {
    res.status(400).json({error:"tipo non valido"});
  }
});

// ADMIN: modifica totali manualmente
app.post("/admin/updateTotals",(req,res)=>{
  const {admin,totalQuota,totalExtra} = req.body;
  if(admin!=="Nuhi") return res.status(403).json({error:"solo admin"});
  db.run("UPDATE totals SET totalQuota=?, totalExtra=? WHERE id=1",[totalQuota,totalExtra],()=>res.json({ok:true}));
});

// ADMIN: aggiungi nuovo utente
app.post("/admin/addUser",(req,res)=>{
  const {admin,name} = req.body;
  if(admin!=="Nuhi") return res.status(403).json({error:"solo admin"});
  if(GROUP.includes(name)) return res.status(400).json({error:"utente giÃ  esiste"});
  GROUP.push(name);
  db.run("INSERT OR IGNORE INTO users(name,role) VALUES(?,?)",[name,"user"],()=>res.json({ok:true}));
});

// DATI FRONTE
app.get("/data",(req,res)=>{
  db.all("SELECT * FROM users",(e,users)=>{
    db.all("SELECT * FROM payments",(e2,payments)=>{
      db.get("SELECT * FROM totals WHERE id=1",(e3,totals)=>{
        const today = new Date();
        const quote = ISLAMIC_QUOTES[today.getDate() % ISLAMIC_QUOTES.length];
        res.json({users,payments,months:MONTHS,quota:QUOTA,quote,totals});
      });
    });
  });
});

app.listen(3000,()=>console.log("APP ATTIVA ðŸ‘‰ http://localhost:3000"));
